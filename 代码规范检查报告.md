# STM32H723 å·¥ç¨‹ä»£ç è§„èŒƒæ£€æŸ¥æŠ¥å‘Š

æ£€æŸ¥æ—¶é—´ï¼š2025-01-11
æ£€æŸ¥èŒƒå›´ï¼šC/C++ æ··ç¼–è§„èŒƒã€å†…å­˜å¯¹é½ã€æ•°æ®ç»“æ„æ‰“åŒ…

---

## âœ… é€šè¿‡çš„æ£€æŸ¥é¡¹

### 1. æ ¸å¿ƒå¤´æ–‡ä»¶ extern "C" è§„èŒƒ
ä»¥ä¸‹å…³é”®å¤´æ–‡ä»¶å·²æ­£ç¡®ä½¿ç”¨ `extern "C"` åŒ…è£¹ï¼š
- âœ… `bsp_fdcan.h` - CAN é©±åŠ¨æ¥å£
- âœ… `dm_motor_drv.h` - DM ç”µæœºé©±åŠ¨åº•å±‚
- âœ… `dm_motor_ctrl.h` - DM ç”µæœºæ§åˆ¶å±‚
- âœ… `dm_motor.h` - DM ç”µæœº C++ å°è£…
- âœ… `bsp_system.h` - ç³»ç»Ÿ BSP
- âœ… `scheduler.h` - ä»»åŠ¡è°ƒåº¦å™¨
- âœ… `motor_task.h` - ç”µæœºä»»åŠ¡
- âœ… `uart_task.h` - ä¸²å£ä»»åŠ¡
- âœ… `imu_temp_ctrl.h` - IMU æ¸©æ§ä»»åŠ¡

### 2. CMakeLists.txt é…ç½®æ­£ç¡®æ€§
- âœ… ç¡¬ä»¶æµ®ç‚¹é…ç½®æ­£ç¡®ï¼š`-mfloat-abi=hard -mfpu=fpv5-d16`
- âœ… CMSIS-DSP å®å®šä¹‰æ­£ç¡®ï¼š`ARM_MATH_CM7`
- âœ… å¯åŠ¨æ–‡ä»¶åŒ…å«æ­£ç¡®ï¼š`Core/*.s` å·²æ”¶é›†
- âœ… æ•°å­¦åº“é“¾æ¥æ­£ç¡®ï¼š`target_link_libraries(...elf m)`
- âœ… DSP åº“ç¼–è¯‘æ­£ç¡®ï¼šåªç¼–è¯‘æ±‡æ€»æ–‡ä»¶ï¼Œé¿å…é‡å¤å®šä¹‰

### 3. CAN ç¼“å†²åŒºä½¿ç”¨è§„èŒƒ
- âœ… CAN æ¥æ”¶ç¼“å†²åŒºä½¿ç”¨æ ˆåˆ†é…ï¼ˆå±€éƒ¨å˜é‡ï¼‰ï¼Œè‡ªåŠ¨ 4 å­—èŠ‚å¯¹é½
- âœ… ç¼“å†²åŒºå¤§å°åˆç†ï¼š`uint8_t rx_data[8]`ï¼ˆæ ‡å‡† CAN å¸§ï¼‰

---

## âš ï¸ å»ºè®®æ”¹è¿›çš„é—®é¢˜

### é—®é¢˜ 1ï¼šéƒ¨åˆ† C å¤´æ–‡ä»¶ç¼ºå°‘ extern "C" ä¿æŠ¤

**é£é™©ç­‰çº§**ï¼šä½ï¼ˆå½“å‰å·¥ç¨‹å¯å·¥ä½œï¼Œä½†ä¸ç¬¦åˆæœ€ä½³å®è·µï¼‰

**é—®é¢˜æè¿°**ï¼š
ä»¥ä¸‹ 11 ä¸ª C å¤´æ–‡ä»¶ç¼ºå°‘ `extern "C"` åŒ…è£¹ï¼š

```
Application/app/algorithm/Mahony/MahonyAHRS.h
Application/app/algorithm/_imu/controller.h
Application/app/algorithm/_imu/kalman_filter.h
Application/app/algorithm/_imu/pid.h
Application/app/algorithm/_imu/QuaternionEKF.h
Application/app/algorithm/_imu/user_lib.h
Application/bsp/BMI088/BMI088driver.h
Application/bsp/BMI088/BMI088Middleware.h
Application/bsp/BMI088/BMI088reg.h
Application/bsp/BMI088/bsp_dwt.h
Application/bsp/usart/bsp_usart.h
```

**å½“å‰çŠ¶æ€**ï¼š
è¿™äº›å¤´æ–‡ä»¶è¢« `imu_temp_ctrl.h` åŒ…å«ï¼Œè€Œ `imu_temp_ctrl.h` æœ‰ `extern "C"` ä¿æŠ¤ï¼Œæ‰€ä»¥å½“å‰å¯ä»¥å·¥ä½œã€‚

**ä¸ºä»€ä¹ˆéœ€è¦æ”¹è¿›**ï¼š
1. **åŒ…å«é¡ºåºæ•æ„Ÿ**ï¼šå¦‚æœæœªæ¥æœ‰ C++ æ–‡ä»¶ç›´æ¥åŒ…å«è¿™äº›å¤´æ–‡ä»¶ï¼ˆç»•è¿‡ imu_temp_ctrl.hï¼‰ï¼Œä¼šå¯¼è‡´ç¬¦å·ä¿®é¥°é”™è¯¯
2. **ä¸ç¬¦åˆæœ€ä½³å®è·µ**ï¼šæ¯ä¸ª C å¤´æ–‡ä»¶åº”è¯¥ç‹¬ç«‹å…·å¤‡ C++ å…¼å®¹æ€§
3. **ç»´æŠ¤æ€§å·®**ï¼šä¾èµ–å¤–å±‚åŒ…è£¹å®¹æ˜“åœ¨é‡æ„æ—¶å‡ºé”™

**å»ºè®®ä¿®æ”¹æ–¹æ¡ˆ**ï¼š

ä¸ºæ¯ä¸ª C å¤´æ–‡ä»¶æ·»åŠ æ ‡å‡†ä¿æŠ¤ï¼Œç¤ºä¾‹ï¼š

```c
#ifndef KALMAN_FILTER_H
#define KALMAN_FILTER_H

#ifdef __cplusplus
extern "C" {
#endif

/* åŸæœ‰å£°æ˜ */
#include "arm_math.h"
// ...

#ifdef __cplusplus
}
#endif

#endif // KALMAN_FILTER_H
```

**ä¿®æ”¹ä¼˜å…ˆçº§**ï¼š
- ğŸ”¥ é«˜ä¼˜å…ˆçº§ï¼ˆå»ºè®®ç«‹å³ä¿®æ”¹ï¼‰ï¼š
  - `kalman_filter.h`ï¼ˆåŒ…å« CMSIS-DSPï¼Œè¢«å¤šå¤„ä½¿ç”¨ï¼‰
  - `QuaternionEKF.h`ï¼ˆæ ¸å¿ƒç®—æ³•ï¼Œå¯èƒ½è¢« C++ ç›´æ¥è°ƒç”¨ï¼‰
  - `BMI088driver.h`ï¼ˆç¡¬ä»¶é©±åŠ¨ï¼Œæ¥å£ç¨³å®šï¼‰

- â³ ä¸­ä¼˜å…ˆçº§ï¼ˆåç»­ä¼˜åŒ–ï¼‰ï¼š
  - `MahonyAHRS.h`, `pid.h`, `controller.h`

- âœ¨ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰ï¼š
  - `BMI088reg.h`, `BMI088Middleware.h`ï¼ˆçº¯å¯„å­˜å™¨å®šä¹‰ï¼Œä¸å¤ªå¯èƒ½è¢« C++ ç›´æ¥åŒ…å«ï¼‰

---

### é—®é¢˜ 2ï¼šmotor_ctrl_t ç»“æ„ä½“å­˜åœ¨å†…å­˜ç©ºæ´

**é£é™©ç­‰çº§**ï¼šæä½ï¼ˆä¸å½±å“åŠŸèƒ½ï¼Œä»…å½±å“å†…å­˜æ•ˆç‡ï¼‰

**é—®é¢˜æè¿°**ï¼š

`dm_motor_drv.h:170-179` çš„ `motor_ctrl_t` ç»“æ„ä½“å®šä¹‰ï¼š

```c
typedef struct {
    uint8_t mode;      // 1 byte
    float pos_set;     // 4 bytes (ä¼šæœ‰ 3 å­—èŠ‚å¡«å……)
    float vel_set;     // 4 bytes
    float tor_set;     // 4 bytes
    float cur_set;     // 4 bytes
    float kp_set;      // 4 bytes
    float kd_set;      // 4 bytes
} motor_ctrl_t;
```

**å†…å­˜å¸ƒå±€åˆ†æ**ï¼š
```
offset  field       size    padding
0       mode        1       3 (å¡«å……åˆ° 4 å­—èŠ‚å¯¹é½)
4       pos_set     4       0
8       vel_set     4       0
12      tor_set     4       0
16      cur_set     4       0
20      kp_set      4       0
24      kd_set      4       0
æ€»å¤§å°ï¼š28 å­—èŠ‚ï¼ˆå®é™…ä½¿ç”¨ 25 å­—èŠ‚ï¼Œæµªè´¹ 3 å­—èŠ‚ï¼‰
```

**å½±å“**ï¼š
- âœ… ä¸å½±å“ CAN é€šä¿¡ï¼ˆæ•°æ®æ˜¯æ‰‹åŠ¨æ‰“åŒ…çš„ï¼Œä¸ç›´æ¥å‘é€ç»“æ„ä½“ï¼‰
- âš ï¸ æ¯ä¸ªç”µæœºå®ä¾‹æµªè´¹ 3 å­—èŠ‚
- âš ï¸ å¦‚æœæœ‰ 100 ä¸ªç”µæœºï¼Œæµªè´¹ 300 å­—èŠ‚ï¼ˆå¯¹ 320KB RAM æ¥è¯´å¯å¿½ç•¥ï¼‰

**å»ºè®®ä¼˜åŒ–æ–¹æ¡ˆ**ï¼ˆå¯é€‰ï¼‰ï¼š

```c
typedef struct {
    float pos_set;     // ç§»åˆ°æœ€å‰é¢
    float vel_set;
    float tor_set;
    float cur_set;
    float kp_set;
    float kd_set;
    uint8_t mode;      // ç§»åˆ°æœ€å
    uint8_t reserved[3]; // æ˜¾å¼å¡«å……ï¼ˆæˆ–ä½¿ç”¨ __attribute__((packed))ï¼‰
} motor_ctrl_t;
```

æˆ–ä½¿ç”¨ç´§å‡‘æ‰“åŒ…ï¼ˆä¸æ¨èï¼Œå¯èƒ½å½±å“è®¿é—®æ€§èƒ½ï¼‰ï¼š
```c
typedef struct {
    uint8_t mode;
    float pos_set;
    // ...
} __attribute__((packed)) motor_ctrl_t;
```

**ä¿®æ”¹ä¼˜å…ˆçº§**ï¼šâœ¨ ä½ï¼ˆå¯ä¸ä¿®æ”¹ï¼‰

---

### é—®é¢˜ 3ï¼šç¼ºå°‘æ˜¾å¼å¯¹é½çš„ DMA/CAN ç¼“å†²åŒº

**é£é™©ç­‰çº§**ï¼šä½ï¼ˆSTM32H7 æ ˆé»˜è®¤ 8 å­—èŠ‚å¯¹é½ï¼Œå±€éƒ¨å˜é‡å®‰å…¨ï¼‰

**é—®é¢˜æè¿°**ï¼š
é¡¹ç›®ä¸­çš„ CAN/UART ç¼“å†²åŒºä¸»è¦æ˜¯æ ˆåˆ†é…çš„å±€éƒ¨å˜é‡ï¼Œä¾‹å¦‚ï¼š

```c
// dm_motor_ctrl.c:190
void fdcan1_rx_callback(void) {
    uint16_t rec_id;
    uint8_t rx_data[8] = {0};  // æ ˆåˆ†é…ï¼Œæœªæ˜¾å¼å¯¹é½
    fdcanx_receive(&hfdcan1, &rec_id, rx_data);
    // ...
}
```

**å½“å‰çŠ¶æ€**ï¼š
- âœ… STM32H7 çš„æ ˆé»˜è®¤ 8 å­—èŠ‚å¯¹é½ï¼Œå±€éƒ¨æ•°ç»„è‡ªåŠ¨æ»¡è¶³ 4 å­—èŠ‚å¯¹é½è¦æ±‚
- âœ… HAL åº“å‡½æ•°å†…éƒ¨ä¼šå¤„ç† DMA å¯¹é½ï¼ˆå¦‚æœä½¿ç”¨ DMAï¼‰

**æ½œåœ¨é£é™©**ï¼š
- å¦‚æœæœªæ¥å°†ç¼“å†²åŒºæ”¹ä¸ºå…¨å±€å˜é‡æˆ–é™æ€å˜é‡ï¼Œä¸”ç¼–è¯‘å™¨ä¼˜åŒ–å¯¼è‡´æœªå¯¹é½ï¼Œå¯èƒ½å‡ºç° DMA é”™è¯¯

**å»ºè®®é¢„é˜²æªæ–½**ï¼ˆå¯é€‰ï¼‰ï¼š

å¯¹äº DMA ç¼“å†²åŒºï¼ˆå¦‚ UART DMA æ¥æ”¶ï¼‰ï¼Œæ˜¾å¼å£°æ˜å¯¹é½ï¼š

```c
// æ­£ç¡®ç¤ºä¾‹
__attribute__((aligned(4))) static uint8_t uart_rx_buffer[256];
__attribute__((aligned(4))) static uint8_t uart_tx_buffer[256];
```

**ä¿®æ”¹ä¼˜å…ˆçº§**ï¼šâ³ ä¸­ï¼ˆå¦‚æœå¯ç”¨ UART DMAï¼Œå»ºè®®æ·»åŠ ï¼‰

---

## ğŸ“Š ç»“æ„ä½“å¤§å°æ±‡æ€»

| ç»“æ„ä½“ | å®šä¹‰ä½ç½® | å®é™…å¤§å° | ç†è®ºæœ€å° | æµªè´¹ | è¯„ä»· |
|--------|---------|---------|---------|------|------|
| `esc_inf_t` | dm_motor_drv.h:97 | 180 bytes | 180 bytes | 0 | âœ… ä¼˜ç§€ |
| `motor_fbpara_t` | dm_motor_drv.h:151 | 56 bytes | 56 bytes | 0 | âœ… ä¼˜ç§€ |
| `motor_ctrl_t` | dm_motor_drv.h:170 | 28 bytes | 25 bytes | 3 bytes | âš ï¸ å¯ä¼˜åŒ– |
| `motor_t` | dm_motor_drv.h:181 | 268 bytes | 265 bytes | 3 bytes | âš ï¸ å¯ä¼˜åŒ– |
| `QEKF_INS_t` | QuaternionEKF.h:29 | ~200 bytes | - | - | âœ… æ­£å¸¸ |

**æ€»ç»“**ï¼š
- å…¨å±€ `motor_t motor[6]` æ•°ç»„å¤§å°ï¼š6 Ã— 268 = 1608 å­—èŠ‚
- å¦‚æœä¼˜åŒ– `motor_ctrl_t`ï¼Œå¯èŠ‚çœ 6 Ã— 3 = 18 å­—èŠ‚ï¼ˆå¯å¿½ç•¥ï¼‰

---

## ğŸ” C/C++ æ··ç¼–å®‰å…¨æ€§æ£€æŸ¥

### C++ è°ƒç”¨ C å‡½æ•°é“¾è·¯åˆ†æ

```
main.cpp (C++)
  â†“ #include "imu_temp_ctrl.h" (æœ‰ extern "C")
    â†“ #include "QuaternionEKF.h" (âŒ æ—  extern "C")
      â†“ #include "kalman_filter.h" (âŒ æ—  extern "C")
        â†“ #include "arm_math.h" (C åº“ï¼Œéœ€è¦ extern "C")
```

**é£é™©ç‚¹**ï¼š
- å¦‚æœ `imu_temp_ctrl.h` çš„ `extern "C"` ä¸å°å¿ƒç§»é™¤ï¼Œä¼šå¯¼è‡´é“¾æ¥é”™è¯¯
- å¦‚æœå…¶ä»– C++ æ–‡ä»¶ç›´æ¥åŒ…å« `QuaternionEKF.h`ï¼Œä¼šå‡ºç°ç¬¦å·ä¿®é¥°ä¸åŒ¹é…

**å½“å‰ä¿æŠ¤æªæ–½**ï¼š
- âœ… æ‰€æœ‰ C++ æ–‡ä»¶ï¼ˆmain.cpp, motor_task.cppï¼‰åªé€šè¿‡æœ‰ `extern "C"` çš„æ¥å£å¤´æ–‡ä»¶è°ƒç”¨ C ä»£ç 
- âœ… CMakeLists.txt æ­£ç¡®é…ç½®äº† C å’Œ C++ ç¼–è¯‘å™¨

---

## ğŸ“‹ ä¿®æ”¹å»ºè®®ä¼˜å…ˆçº§

### ğŸ”¥ é«˜ä¼˜å…ˆçº§ï¼ˆå»ºè®®ç«‹å³ä¿®æ”¹ï¼‰

1. **ä¸ºå…³é”® C å¤´æ–‡ä»¶æ·»åŠ  extern "C" ä¿æŠ¤**
   - `kalman_filter.h`
   - `QuaternionEKF.h`
   - `BMI088driver.h`

   **é¢„è®¡å·¥ä½œé‡**ï¼š15 åˆ†é’Ÿ
   **æ”¶ç›Š**ï¼šæå‡ä»£ç å¥å£®æ€§å’Œå¯ç»´æŠ¤æ€§

### â³ ä¸­ä¼˜å…ˆçº§ï¼ˆåç»­ä¼˜åŒ–ï¼‰

2. **ä¸ºç®—æ³•å¤´æ–‡ä»¶æ·»åŠ  extern "C" ä¿æŠ¤**
   - `MahonyAHRS.h`, `pid.h`, `controller.h`, `user_lib.h`

   **é¢„è®¡å·¥ä½œé‡**ï¼š10 åˆ†é’Ÿ

3. **å¦‚æœå¯ç”¨ UART DMAï¼Œæ·»åŠ ç¼“å†²åŒºå¯¹é½å£°æ˜**
   - æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€/é™æ€ DMA ç¼“å†²åŒº
   - æ·»åŠ  `__attribute__((aligned(4)))`

   **é¢„è®¡å·¥ä½œé‡**ï¼š5 åˆ†é’Ÿ

### âœ¨ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

4. **ä¼˜åŒ– motor_ctrl_t ç»“æ„ä½“å¸ƒå±€**
   - èŠ‚çœ 3 å­—èŠ‚å†…å­˜ï¼ˆå½±å“æå°ï¼‰

   **é¢„è®¡å·¥ä½œé‡**ï¼š2 åˆ†é’Ÿ
   **æ”¶ç›Š**ï¼šæä½

5. **ä¸ºå¯„å­˜å™¨å®šä¹‰å¤´æ–‡ä»¶æ·»åŠ  extern "C"**
   - `BMI088reg.h`, `BMI088Middleware.h`, `bsp_dwt.h`

   **é¢„è®¡å·¥ä½œé‡**ï¼š5 åˆ†é’Ÿ
   **æ”¶ç›Š**ï¼šä½ï¼ˆè¿™äº›æ–‡ä»¶å¾ˆå°‘è¢«ç›´æ¥åŒ…å«ï¼‰

---

## âœ… æ€»ä½“è¯„ä»·

**ä»£ç è´¨é‡**ï¼šâ­â­â­â­ (4/5)

**ä¼˜ç‚¹**ï¼š
1. âœ… æ ¸å¿ƒæ¥å£å±‚å·²æ­£ç¡®ä½¿ç”¨ `extern "C"`
2. âœ… CMake é…ç½®è§„èŒƒï¼Œç¼–è¯‘é€‰é¡¹æ­£ç¡®
3. âœ… CAN ç¼“å†²åŒºä½¿ç”¨å®‰å…¨ï¼ˆæ ˆåˆ†é…ï¼‰
4. âœ… ç»“æ„ä½“è®¾è®¡åˆç†ï¼Œå†…å­˜æµªè´¹æå°‘

**æ”¹è¿›ç©ºé—´**ï¼š
1. âš ï¸ éƒ¨åˆ†åº•å±‚å¤´æ–‡ä»¶ç¼ºå°‘ç‹¬ç«‹çš„ `extern "C"` ä¿æŠ¤
2. âš ï¸ ç»“æ„ä½“æœ‰è½»å¾®å†…å­˜ç©ºæ´ï¼ˆå¯å¿½ç•¥ï¼‰

**æ€»ç»“**ï¼š
å½“å‰å·¥ç¨‹çš„ C/C++ æ··ç¼–è§„èŒƒåŸºæœ¬ç¬¦åˆè¦æ±‚ï¼Œæ²¡æœ‰è‡´å‘½é—®é¢˜ã€‚å»ºè®®æŒ‰ä¼˜å…ˆçº§é€æ­¥æ·»åŠ ç¼ºå¤±çš„ `extern "C"` ä¿æŠ¤ï¼Œæå‡ä»£ç çš„å¥å£®æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

---

## ğŸ“ å¿«é€Ÿä¿®å¤è„šæœ¬ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æ‰¹é‡æ·»åŠ  `extern "C"`ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¿®æ”¹æ¨¡æ¿ï¼š

```c
// åœ¨å¤´æ–‡ä»¶å¼€å¤´æ·»åŠ ï¼ˆ#ifndef ä¹‹åï¼‰
#ifdef __cplusplus
extern "C" {
#endif

// åœ¨å¤´æ–‡ä»¶ç»“å°¾æ·»åŠ ï¼ˆ#endif ä¹‹å‰ï¼‰
#ifdef __cplusplus
}
#endif
```

ç¤ºä¾‹ï¼ˆkalman_filter.hï¼‰ï¼š
```diff
 #ifndef __KALMAN_FILTER_H
 #define __KALMAN_FILTER_H

+#ifdef __cplusplus
+extern "C" {
+#endif
+
 #include "stdint.h"
 #include "stdlib.h"
 #include "arm_math.h"
 // ... å…¶ä»–å£°æ˜ ...

+#ifdef __cplusplus
+}
+#endif
+
 #endif //__KALMAN_FILTER_H
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-01-11
**æ£€æŸ¥å·¥å…·**ï¼šClaude Code + äººå·¥å®¡æŸ¥
**å»ºè®®å®¡é˜…è€…**ï¼šé¡¹ç›®è´Ÿè´£äºº
